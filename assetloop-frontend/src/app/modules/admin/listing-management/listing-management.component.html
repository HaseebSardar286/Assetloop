<div class="d-flex flex-column vh-100">
  <app-header (logout)="onLogout()"></app-header>
  <div class="d-flex flex-grow-1">
    <app-admin-sidebar></app-admin-sidebar>
    <main class="flex-grow-1 p-4 bg-light">
      <h2 class="mb-4">Listing Management</h2>
      <!-- Search Card -->
      <div class="card mb-4">
        <div class="card-header">Search Listings</div>
        <div class="card-body">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Search by name, owner, or status..."
              [(ngModel)]="searchTerm"
              (input)="searchListings()"
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              (click)="clearSearch()"
            >
              Clear
            </button>
          </div>
        </div>
      </div>
      <!-- Listings Card -->
      <div class="card">
        <div class="card-header">
          All Listings ({{ filteredListings.length || 0 }})
        </div>
        <div class="card-body">
          <!-- Loading Spinner -->
          <div *ngIf="loading" class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading listings...</p>
          </div>
          <table class="table table-striped" *ngIf="!loading">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Price (PKR/day)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let listing of paginatedListings">
                <td>{{ listing._id }}</td>
                <td>{{ listing.name || "N/A" }}</td>
                <td>
                  {{
                    listing.owner
                      ? (
                          (listing.owner.firstName || "") +
                          " " +
                          (listing.owner.middleName || "") +
                          " " +
                          (listing.owner.lastName || "")
                        ).trim() || "Unknown Owner"
                      : "N/A"
                  }}
                </td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="{
                      'bg-danger': listing.status.toLowerCase() === 'inactive',
                      'bg-primary': listing.status.toLowerCase() === 'active'
                    }"
                  >
                    {{ listing.status || "N/A" }}
                  </span>
                </td>
                <td>{{ listing.price || "N/A" }}</td>
                <td>
                  <button
                    class="btn btn-info btn-sm me-2"
                    [routerLink]="['/admin/view-listing', listing._id]"
                  >
                    View
                  </button>
                  <button
                    class="btn btn-warning btn-sm me-2"
                    *ngIf="listing.status?.toLowerCase() === 'active'"
                    [routerLink]="['/admin/status-listing', listing._id]"
                  >
                    Deactivate
                  </button>
                  <button
                    class="btn btn-success btn-sm me-2"
                    *ngIf="listing.status?.toLowerCase() === 'inactive'"
                    [routerLink]="['/admin/status-listing', listing._id]"
                  >
                    Activate
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    (click)="deleteListing(listing._id)"
                  >
                    Delete
                  </button>
                </td>
              </tr>
              <tr *ngIf="paginatedListings.length === 0">
                <td colspan="6" class="text-center text-muted">
                  No listings found
                </td>
              </tr>
            </tbody>
          </table>
          <!-- Pagination -->
          <nav aria-label="Listings pagination" *ngIf="totalPages > 1">
            <ul class="pagination justify-content-center mt-3">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a
                  class="page-link"
                  (click)="changePage(currentPage - 1)"
                  href="#"
                  >Previous</a
                >
              </li>
              <li
                class="page-item"
                *ngFor="let page of [].constructor(totalPages); let i = index"
                [class.active]="currentPage === i + 1"
              >
                <a class="page-link" (click)="changePage(i + 1)" href="#">{{
                  i + 1
                }}</a>
              </li>
              <li
                class="page-item"
                [class.disabled]="currentPage === totalPages"
              >
                <a
                  class="page-link"
                  (click)="changePage(currentPage + 1)"
                  href="#"
                  >Next</a
                >
              </li>
            </ul>
          </nav>
          <!-- Error Message -->
          <div *ngIf="error" class="alert alert-danger mt-4" role="alert">
            {{ error }}
            <button
              type="button"
              class="btn-close"
              (click)="error = null"
            ></button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
