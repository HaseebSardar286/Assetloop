<div class="booking-payments">
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="alert alert-danger" *ngIf="error">{{ error }}</div>
  <div class="alert alert-info" *ngIf="info && !error">{{ info }}</div>

  <!-- Show booking selection list if no specific booking is selected -->
  <ng-container *ngIf="!loading && !booking && allBookings.length > 0">
    <h4 class="mb-3">Select a Booking</h4>
    <div class="list-group">
      <a
        *ngFor="let b of allBookings"
        href="#"
        class="list-group-item list-group-item-action"
        (click)="selectBooking(b); $event.preventDefault()"
      >
        <div class="d-flex w-100 justify-content-between">
          <h5 class="mb-1">{{ b.name }}</h5>
          <small>{{ b.status | titlecase }}</small>
        </div>
        <p class="mb-1">{{ b.address }}</p>
        <div class="d-flex justify-content-between">
          <small>
            <strong>Price:</strong> PKR {{ b.price | number : "1.0-0" }} | 
            <strong>Paid:</strong> PKR {{ (b.totalPaid || 0) | number : "1.0-0" }} | 
            <strong>Due:</strong> PKR {{ getAmountDue(b) | number : "1.0-0" }}
          </small>
          <small>{{ b.startDate | date : "shortDate" }} - {{ b.endDate | date : "shortDate" }}</small>
        </div>
      </a>
    </div>
  </ng-container>

  <ng-container *ngIf="!loading && booking">
    <h4 class="mb-3">Booking Summary</h4>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title mb-1">{{ booking.name }}</h5>
        <div class="text-muted mb-2">{{ booking.address }}</div>
        <div class="row">
          <div class="col-md-4">
            <strong>Price:</strong> PKR {{ booking.price | number : "1.0-0" }}
          </div>
          <div class="col-md-4">
            <strong>Paid:</strong> PKR {{
            booking.totalPaid || 0 | number : "1.0-0"
            }}
          </div>
          <div class="col-md-4">
            <strong>Amount Due:</strong>
            <span [ngClass]="{
                'badge bg-success': amountDue <= 0,
                'badge bg-warning text-dark': amountDue > 0
              }">
              PKR {{ amountDue | number : "1.0-0" }}
            </span>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-6">
            <strong>Start:</strong>
            {{ booking.startDate | date : "mediumDate" }}
          </div>
          <div class="col-md-6">
            <strong>End:</strong> {{ booking.endDate | date : "mediumDate" }}
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="amountDue <= 0" class="alert alert-success mb-3">
      Payment complete. No amount due.
    </div>

    <h4>Payment History & Schedule</h4>
    <ul class="list-group mb-3" *ngIf="upcomingPayments.length; else noneDue">
      <li class="list-group-item d-flex justify-content-between align-items-center"
        *ngFor="let payment of upcomingPayments">
        <div>
          <span class="fw-bold">{{ payment.type | titlecase }}</span>
          <span class="text-muted ms-2" *ngIf="payment.date || payment.createdAt">
            {{ payment.date || (payment.createdAt | date) }}
          </span>
        </div>
        <div>
          <span class="badge rounded-pill me-2" [ngClass]="{
            'bg-success': payment.status === 'successful' || payment.status === 'completed',
            'bg-warning text-dark': payment.status === 'pending',
            'bg-danger': payment.status === 'failed'
          }">{{ payment.status | titlecase }}</span>
          <span class="fw-bold">PKR {{ payment.amount | number : "1.0-0" }}</span>
        </div>
      </li>
    </ul>
    <ng-template #noneDue>
      <div class="alert alert-info">No payment history or upcoming payments.</div>
    </ng-template>

    <div class="mt-2">
      <h4>Security Deposit</h4>
      <p>PKR {{ securityDeposit | number : "1.0-0" }}</p>
    </div>

    <div class="form-check mt-2">
      <input type="checkbox" class="form-check-input" id="autoPay" [(ngModel)]="autoPay" />
      <label class="form-check-label" for="autoPay">Enable Auto-Pay</label>
    </div>

    <div class="mt-4">
      <button class="btn btn-primary me-2" (click)="payNow()" [disabled]="loading || amountDue <= 0">
        {{ loading ? "Redirecting..." : amountDue > 0 ? "Pay with Stripe" : "Paid" }}
      </button>
      <button class="btn btn-success" (click)="testPayment()" [disabled]="loading || amountDue <= 0" title="Simulate payment without Stripe (for testing)">
        Test Payment
      </button>
    </div>
  </ng-container>
</div>